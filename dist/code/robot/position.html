<!DOCTYPE html><html lang="en"><head><title>robot/position</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="robot/position"><meta name="groc-project-path" content="dist/exercise/assets/robot/position.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dist/exercise/assets/robot/position.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Position</span>(<span class="hljs-params">body</span>) </span>{
  <span class="hljs-keyword">var</span> bodyElement = body.getElement();
  <span class="hljs-keyword">var</span> previous = {};
  <span class="hljs-keyword">var</span> position = body.getPosition();
  position.angle = <span class="hljs-number">0</span>;
  position.scale = <span class="hljs-number">1</span>;

  <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>, <span class="hljs-string">'x'</span>, {
    get: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> position.x;
    },
    set: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
      previous.x = position.x;
      position.x = value;
      emitChange(<span class="hljs-string">'xyChange'</span>);
    }
  });

  <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>, <span class="hljs-string">'y'</span>, {
    get: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> position.y;
    },
    set: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
      previous.y = position.y;
      position.y = value;
      emitChange(<span class="hljs-string">'xyChange'</span>);
    }
  });

  <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>, <span class="hljs-string">'scale'</span>, {
    get: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> position.scale;
    },
    set: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
      position.scale = value;
      emitChange(<span class="hljs-string">'orientationChange'</span>);
    }
  });

  <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>, <span class="hljs-string">'angle'</span>, {
    get: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> position.angle;
    },
    set: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
      position.angle = value;
      emitChange(<span class="hljs-string">'orientationChange'</span>);
    }
  });

  <span class="hljs-keyword">this</span>.get = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">return</span> _.clone(position);
  }

  <span class="hljs-keyword">this</span>.emitChange = emitChange;

  bodyElement.addEventListener(<span class="hljs-string">'xyChange'</span>, orient.bind(<span class="hljs-keyword">this</span>));
  bodyElement.addEventListener(<span class="hljs-string">'orientationChange'</span>, body.animateMove);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emitChange</span>(<span class="hljs-params">changeType, changedProperties</span>)</span>{
    <span class="hljs-keyword">var</span> changeEventData = {
      position: body.getPosition(),
      box: bodyElement.getBoundingClientRect()
    };

    changeEventData = _.assign(changeEventData, changedProperties)

    <span class="hljs-keyword">var</span> changeEvent = <span class="hljs-keyword">new</span> CustomEvent(changeType, {detail: changeEventData});
    bodyElement.dispatchEvent(changeEvent);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">orient</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">this</span>.angle = calculateAngle(previous, position);
    <span class="hljs-keyword">this</span>.scale = calculateScale(previous, position);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDirection</span>(<span class="hljs-params">distance</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.sign(distance);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateAngle</span>(<span class="hljs-params">previous, destination</span>) </span>{
    <span class="hljs-keyword">var</span> xDist = destination.x - previous.x;
    <span class="hljs-keyword">var</span> yDist = previous.y - destination.y;

    <span class="hljs-keyword">if</span>(xDist == <span class="hljs-number">0</span>){
      <span class="hljs-keyword">return</span> getDirection(yDist) * <span class="hljs-number">90</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.atan(yDist/xDist) / <span class="hljs-built_in">Math</span>.PI * <span class="hljs-number">180</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateScale</span>(<span class="hljs-params">previous, destination</span>) </span>{
    <span class="hljs-keyword">var</span> xDist = destination.x - previous.x;

    <span class="hljs-keyword">return</span> getDirection(xDist);
  }

}</div></div></div></div></body></html>